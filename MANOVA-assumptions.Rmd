---
title: "MANOVA assumptions"
output: html_document
date: "2022-08-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(tidyverse)
library(readxl)
library(officer)
library(flextable)
library(extrafont)
library(writexl)
library(rstatix)
library(corrr)
library(corrplot)
library(car)
```

```{r}
SA3_noout <- read_excel("C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\SA3_noout.xlsx")
```


```{r}
str(SA3_noout)
SA3_num <- select_if(SA3_noout, is.numeric)
```


```{r}
correl <- correlate(SA3_num)
correl
```
```{r, fig.height=6, fig.width=8}
correl2 <- cor(SA3_num)
symnum(correl2)
corrplot(correl2, method = 'number')
```
checking assumptions using random variable: no transformation

```{r}
#make a random variable
#any number over 2 in place of 10
random <- rchisq(nrow(SA3_noout), 10)
#run a fake regression
fake <- lm(random~., data=SA3_noout[ , -1])
#create standardized residuals 
standardized <- rstudent(fake)
#create the fitted values 
fitted <- scale(fake$fitted.values)
```

```{r}

##homogeneity
plot(fitted,standardized)
abline(0,0)
abline(v = 0)

#linearity
qqnorm(standardized)
abline(0,1)


#Normality
hist(standardized)

```




checking assumptions using random variable: log base 10 transformation

```{r}
#make a random variable
#any number over 2 in place of 7
randomlog <- rchisq(nrow(SA3_noout), 10)
#run a fake regression
fakelog <- lm(log(randomlog, base=10)~., data=SA3_noout[ , -1])
#create standardized residuals 
standardizedlog <- rstudent(fakelog)
#create the fitted values 
fittedlog <- scale(fakelog$fitted.values)
```

```{r}
##homogeneity
plot(fittedlog,standardizedlog)
abline(0,0)
abline(v = 0)


#linearity
qqnorm(standardizedlog)
abline(0,1)


#Normality
hist(standardizedlog)
```







checking assumptions using random variable: sqrt transformation

```{r}
#make a random variable
#any number over 2 in place of 7
randomsqrt <- rchisq(nrow(SA3_noout), 10)
#run a fake regression
fakesqrt <- lm(sqrt(randomsqrt)~., data=SA3_noout[ , -1])
#create standardized residuals 
standardizedsqrt <- rstudent(fakesqrt)
#create the fitted values 
fittedsqrt <- scale(fakesqrt$fitted.values)
```

```{r}
#homogeneity (unscaled)
plot(fakesqrt$fitted.values, standardizedsqrt)
abline(0,0)
abline(v = 0)

##homogeneity (scaled)
plot(fittedsqrt, standardizedsqrt)
abline(0,0)
abline(v = 0)

#linearity
qqnorm(standardizedsqrt)
abline(0,1)

#Normality
hist(standardizedsqrt)


```



```{r}
#influencial observations (STAR 513: Lecture 5 examples)
# overwhelming to look at
inf_out <- influence.measures(fakesqrt)
# check out Cook's D (column 6)
sum(inf_out$is.inf[, 6])
```






Checking assumptions on actual MANOVA model: setup

```{r}
variables <- cbind(SA3_noout$AA_C, SA3_noout$BiW_C, SA3_noout$BiW_L, 
                   SA3_noout$GoSub_C, SA3_noout$NRB_L, SA3_noout$ProS_L,
                   SA3_noout$SelP_L, SA3_noout$SelM_L, SA3_noout$SnasM_C,
                   SA3_noout$SnasM_C, SA3_noout$TrSman_C, SA3_noout$TrTr_C,
                   SA3_noout$TrTr_L)


#part of Dr. Erin Buchanan's lecture, but Manova code returns error: Error in Anova.mlm(mod, ...) : model is singular
#lm_notransf <- lm(variables ~ gender*race_eth*age_group, data=SA3_noout,
                  #contrasts = list(gender=contr.sum, 
                                   #race_eth=contr.sum,
                                   #age_group=contr.sum))

#manova_notransf <- Manova(lm_notransf, type = "III")

```

Checking assumptions on actual MANOVA model: no transformation

```{r}



manova_out_nt <- manova(variables ~ gender*race_eth*age_group, data=SA3_noout)

fitted1 <- scale(manova_out_nt$fitted.values)

resid <- rstudent(manova_out_nt)

#homogeneity (unscaled)
plot(manova_out_nt$fitted.values, resid)
abline(0,0)
abline(v = 0)

#homogeneity (scaled)
plot(fitted1, resid)
abline(0,0)
abline(v = 0)

#linearity
qqnorm(resid)
abline(0,1, lty=2)

#normality
hist(resid)

leveneTest(variables ~ gender*race_eth*age_group, data=SA3_noout)
```

Checking assumptions on actual MANOVA model: log base 10 transformation

```{r}

manova_out_log <- manova(log(variables,base=10) ~ gender*race_eth*age_group, data=SA3_noout,
                        subject="ID")


resid_log <- rstudent(manova_out_log)
plot(manova_out_log$fitted.values, resid_log)
qqnorm(resid_log)
abline(0,1, lty=2)
hist(resid_log)
```




Checking assumptions on actual MANOVA model: sqrt transformation

```{r}

manova_out_sqrt <- manova(sqrt(variables) ~ gender*race_eth*age_group, data=SA3_noout,
                        subject="ID")


resid_sqrt <- rstudent(manova_out_sqrt)

#homogeneity
plot(manova_out_sqrt$fitted.values, resid_sqrt)

#linearity
qqnorm(resid_sqrt)
abline(0,1, lty=2)

#normality
hist(resid_sqrt)
```