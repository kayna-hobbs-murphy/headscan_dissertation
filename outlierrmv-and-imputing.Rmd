---
title: "MANOVA outlier assessment"
output:
  word_document: default
  html_document: default
date: "2022-08-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(tidyverse)
library(readxl)
library(flextable)
library(extrafont)
library(writexl)
library(rstatix)
library(fauxnaif) 
library(missMDA)
```



To check for outliers:

Standardized (or studentized) residuals are residuals that have been
“standardized” by dividing each residual by it’s SE.
• They have approximately a t-distribution, which is approximately
normal for moderate sample sizes, so we expect that about 95% of the
standardized residuals will be between -2 and +2. Values greater in
absolute value than 3.5 are usually considered outliers.
• In R, standardized residuals can be found using
rstandard(ModelObject). (FROM 511/512 notes!)



```{r table-function}
#times new roman tables
my_ft_theme <- function(ft, ...) {
  # Remove vertical cell padding
  ft <- padding(ft, padding.top = 0, padding.bottom = 0, part = "all")
  
  # Change font to TNR 11
  ft <- font(ft, fontname = "Times New Roman", part = "all")
  ft <- fontsize(ft, part = "all", size = 12)
  ft
}
```

```{r}
#remove identifiers and demographic data

headscan_full<-read_excel("C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\headscan_full.xlsx")

headscan_full$AA_C <- headscan_full$AA_C *10
headscan_full$BGl_C <- headscan_full$BGl_C * 10
headscan_full$BiW_C <- headscan_full$BiW_C *10
headscan_full$BiW_L <- headscan_full$BiW_L *10
headscan_full$ChCh_C <- headscan_full$ChCh_C *10
headscan_full$GoSub_C <- headscan_full$GoSub_C *10
headscan_full$NRB_L <- headscan_full$NRB_L *10
headscan_full$ProA_L <- headscan_full$ProA_L *10
headscan_full$ProA_C <- headscan_full$ProA_C *10
headscan_full$ProS_C <- headscan_full$ProS_C *10
headscan_full$ProS_L <- headscan_full$ProS_L *10
headscan_full$SelP_C <- headscan_full$SelP_C *10
headscan_full$SelP_L <- headscan_full$SelP_L *10
headscan_full$SelDH_C <- headscan_full$SelDH_C *10
headscan_full$SelM_L <- headscan_full$SelM_L *10
headscan_full$SnasM_C <- headscan_full$SnasM_C *10
headscan_full$SmanM_C <- headscan_full$SmanM_C *10
headscan_full$SmanM_L <- headscan_full$SmanM_L *10
headscan_full$SnasM_L <- headscan_full$SnasM_L *10
headscan_full$TrHO_C <- headscan_full$TrHO_C *10
headscan_full$TrEJ_C <- headscan_full$TrEJ_C *10
headscan_full$TrGo_C <- headscan_full$TrGo_C *10
headscan_full$TrSel_C <- headscan_full$TrSel_C *10
headscan_full$TrSman_C <- headscan_full$TrSman_C *10
headscan_full$TrSnas_C <- headscan_full$TrSnas_C *10
headscan_full$TrTr_C <- headscan_full$TrTr_C *10
headscan_full$TrTr_L <- headscan_full$TrTr_L *10

headscan_full$gender <- as.factor(headscan_full$gender)
headscan_full$race_eth <- as.factor(headscan_full$race_eth)
headscan_full$age_group <- as.factor(headscan_full$age_group)

str(headscan_full)
```

```{r}
chosen_data <- headscan_full[c(1,2,4,5,7,8,12,14,16,17,25,27,28,31,32,33)]
```


```{r}
chosen_NAsums <- colSums(is.na(chosen_data))

chosen_NAprops <- colMeans(is.na(chosen_data))

chosen_NAprops1 <- as.data.frame(chosen_NAprops)
chosen_NAprops1 <- rownames_to_column(chosen_NAprops1, "var_name")
chosen_NAprops1 <- chosen_NAprops1 %>% slice(-c(1, 29:33))

chosen_NAsums1 <- as.data.frame(chosen_NAsums)
chosen_NAsums1 <- rownames_to_column(chosen_NAsums1, "var_name")
chosen_NAsums1 <- chosen_NAsums1 %>% slice(-c(1, 29:33))

chosen_NAs <- inner_join(chosen_NAprops1, chosen_NAsums1, by = "var_name", desc)

chosen_NAs$chosen_NAprops<- round(chosen_NAs$chosen_NAprops, digits=4)

chosen_NAs$var_name <- fct_reorder(chosen_NAs$var_name, chosen_NAs$chosen_NAsums, .desc=TRUE)

str(chosen_NAs$chosen_name)

#Size 12 Table TNR
flextable(chosen_NAs) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("NA values for each Chosen Variable") %>% 
  autofit() %>% 
  set_header_labels(values = list(var_name = "Variable",
                                  chosen_NAprops = "Proportion of NA values",
                                  chosen_NAsums = "Count of NA values"))
```





```{r}
chosen_data1 <- chosen_data
#USE THIS LATER FOR MANOVA


#race/eth
#chosen_data1$race_eth <-  
  #recode_factor(chosen_data1$race_eth, 'AIAN'= "Other",
                #'NHOPI' = "Other",
                #'PTNS' = "Other")

#gender
#chosen_data1$gender <-  
  #recode_factor(chosen_data1$gender, 'Non-binary or Other'= "Other",
                #'Prefer not to say' = "Other")

#chosen_data1$gender[is.na(chosen_data1$gender)]="Other"


summary(chosen_data1)
```




```{r}
chosen_data2 <- chosen_data1


sum(is.na(chosen_data1))

```


Next, identify univariate outliers


```{r}
#AA_C
AA_C_out <- chosen_data2 %>% 
  identify_outliers(AA_C)

AA_C_out$extreme_overall <- AA_C_out$is.extreme

AA_C_out <- AA_C_out[c(1,2,19)]



AA_C_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(AA_C)

AA_C_out1$extreme_race_eth <- AA_C_out1$is.extreme

AA_C_out1 <- AA_C_out1[c(2,3,19)]




AA_C_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(AA_C)

AA_C_out2$extreme_gender <- AA_C_out2$is.extreme

AA_C_out2 <- AA_C_out2[c(2,3,19)]



AA_C_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(AA_C)

AA_C_out3$extreme_age <- AA_C_out3$is.extreme

AA_C_out3 <- AA_C_out3[c(2,3,19)]


AA_C_extreme <- full_join(AA_C_out, AA_C_out1, by=c('ID', 'AA_C'))
AA_C_extreme <- full_join(AA_C_extreme, AA_C_out2, by=c('ID', 'AA_C'))
AA_C_extreme <- full_join(AA_C_extreme, AA_C_out3, by=c('ID', 'AA_C'))

AA_C_extreme <- 
  filter(AA_C_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )


AA_C_extreme$extreme_overall <- as.character(AA_C_extreme$extreme_overall)
AA_C_extreme$extreme_race_eth <- as.character(AA_C_extreme$extreme_race_eth)
AA_C_extreme$extreme_gender <- as.character(AA_C_extreme$extreme_gender)
AA_C_extreme$extreme_age <- as.character(AA_C_extreme$extreme_age)
           
AA_C_extreme[is.na(AA_C_extreme)]="Not Outlier"

#Size 12 Table TNR
flextable(AA_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("AA_C Extreme Outliers (mean=61.25mm)") 
#%>% set_header_labels(values = list(AA_C = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(AA_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("AA_C Extreme Outliers (mean=61.25mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(AA_C = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=AA_C))+
  geom_bar(stat="bin", bins=20, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="AA_C Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```

```{r}
#BiW_C
BiW_C_out <- chosen_data2 %>% 
  identify_outliers(BiW_C)

BiW_C_out$extreme_overall <- BiW_C_out$is.extreme

BiW_C_out <- BiW_C_out[c(1,3,19)]



BiW_C_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(BiW_C)

BiW_C_out1$extreme_race_eth <- BiW_C_out1$is.extreme

BiW_C_out1 <- BiW_C_out1[c(2,4,19)]




BiW_C_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(BiW_C)

BiW_C_out2$extreme_gender <- BiW_C_out2$is.extreme

BiW_C_out2 <- BiW_C_out2[c(2,4,19)]



BiW_C_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(BiW_C)

BiW_C_out3$extreme_age <- BiW_C_out3$is.extreme

BiW_C_out3 <- BiW_C_out3[c(2,4,19)]


BiW_C_extreme <- full_join(BiW_C_out, BiW_C_out1, by=c('ID', 'BiW_C'))
BiW_C_extreme <- full_join(BiW_C_extreme, BiW_C_out2, by=c('ID', 'BiW_C'))
BiW_C_extreme <- full_join(BiW_C_extreme, BiW_C_out3, by=c('ID', 'BiW_C'))

BiW_C_extreme <- 
  filter(BiW_C_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )


BiW_C_extreme$extreme_overall <- as.character(BiW_C_extreme$extreme_overall)
BiW_C_extreme$extreme_race_eth <- as.character(BiW_C_extreme$extreme_race_eth)
BiW_C_extreme$extreme_gender <- as.character(BiW_C_extreme$extreme_gender)
BiW_C_extreme$extreme_age <- as.character(BiW_C_extreme$extreme_age)
           
BiW_C_extreme[is.na(BiW_C_extreme)]="Not Outlier"


#Size 12 Table TNR
flextable(BiW_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("BiW_C Extreme Outliers (mean=133.4mm)") 
#%>% set_header_labels(values = list(BiW_C = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(BiW_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("BiW_C Extreme Outliers (mean=133.4mm)") %>% 
  fit_to_width(7.5) 
#%>% set_header_labels(values = list(BiW_C = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=BiW_C))+
  geom_bar(stat="bin", bins=20, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="BiW_C Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```

```{r}
#BiW_L
BiW_L_out <- chosen_data2 %>% 
  identify_outliers(BiW_L)

BiW_L_out$extreme_overall <- BiW_L_out$is.extreme

BiW_L_out <- BiW_L_out[c(1,4,19)]



BiW_L_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(BiW_L)

BiW_L_out1$extreme_race_eth <- BiW_L_out1$is.extreme

BiW_L_out1 <- BiW_L_out1[c(2,5,19)]




BiW_L_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(BiW_L)

BiW_L_out2$extreme_gender <- BiW_L_out2$is.extreme

BiW_L_out2 <- BiW_L_out2[c(2,5,19)]



BiW_L_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(BiW_L)

BiW_L_out3$extreme_age <- BiW_L_out3$is.extreme

BiW_L_out3 <- BiW_L_out3[c(2,5,19)]


BiW_L_extreme <- full_join(BiW_L_out, BiW_L_out1, by=c('ID', 'BiW_L'))
BiW_L_extreme <- full_join(BiW_L_extreme, BiW_L_out2, by=c('ID', 'BiW_L'))
BiW_L_extreme <- full_join(BiW_L_extreme, BiW_L_out3, by=c('ID', 'BiW_L'))

BiW_L_extreme <- 
  filter(BiW_L_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )


BiW_L_extreme$extreme_overall <- as.character(BiW_L_extreme$extreme_overall)
BiW_L_extreme$extreme_race_eth <- as.character(BiW_L_extreme$extreme_race_eth)
BiW_L_extreme$extreme_gender <- as.character(BiW_L_extreme$extreme_gender)
BiW_L_extreme$extreme_age <- as.character(BiW_L_extreme$extreme_age)
           
BiW_L_extreme[is.na(BiW_L_extreme)]="Not Outlier"


#Size 12 Table TNR
flextable(BiW_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("BiW_L Extreme Outliers (mean=111.2mm)") 
#%>% set_header_labels(values = list(BiW_L = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(BiW_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("BiW_L Extreme Outliers (mean=111.2mm)") %>% 
  fit_to_width(7.5) 
#%>% set_header_labels(values = list(BiW_L = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=BiW_L))+
  geom_bar(stat="bin", bins=20, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="BiW_L Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```


```{r}
#GoSub_C
GoSub_C_out <- chosen_data2 %>% 
  identify_outliers(GoSub_C)

GoSub_C_out$extreme_overall <- GoSub_C_out$is.extreme

GoSub_C_out <- GoSub_C_out[c(1,5,19)]



GoSub_C_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(GoSub_C)

GoSub_C_out1$extreme_race_eth <- GoSub_C_out1$is.extreme

GoSub_C_out1 <- GoSub_C_out1[c(2,6,19)]




GoSub_C_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(GoSub_C)

GoSub_C_out2$extreme_gender <- GoSub_C_out2$is.extreme

GoSub_C_out2 <- GoSub_C_out2[c(2,6,19)]



GoSub_C_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(GoSub_C)

GoSub_C_out3$extreme_age <- GoSub_C_out3$is.extreme

GoSub_C_out3 <- GoSub_C_out3[c(2,6,19)]


GoSub_C_extreme <- full_join(GoSub_C_out, GoSub_C_out1, by=c('ID', 'GoSub_C'))
GoSub_C_extreme <- full_join(GoSub_C_extreme, GoSub_C_out2, by=c('ID', 'GoSub_C'))
GoSub_C_extreme <- full_join(GoSub_C_extreme, GoSub_C_out3, by=c('ID', 'GoSub_C'))

GoSub_C_extreme <- 
  filter(GoSub_C_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

GoSub_C_extreme$extreme_overall <- as.character(GoSub_C_extreme$extreme_overall)
GoSub_C_extreme$extreme_race_eth <- as.character(GoSub_C_extreme$extreme_race_eth)
GoSub_C_extreme$extreme_gender <- as.character(GoSub_C_extreme$extreme_gender)
GoSub_C_extreme$extreme_age <- as.character(GoSub_C_extreme$extreme_age)

GoSub_C_extreme[is.na(GoSub_C_extreme)]="Not Outlier"           

#Size 12 Table TNR
flextable(GoSub_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("GoSub_C Extreme Outliers (mean=99.05mm)") 
#%>% set_header_labels(values = list(GoSub_C = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(GoSub_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("GoSub_C Extreme Outliers (mean=99.05mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(GoSub_C = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=GoSub_C))+
  geom_bar(stat="bin", bins=30, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="GoSub_C Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```


```{r}
#NRB_L
NRB_L_out <- chosen_data2 %>% 
  identify_outliers(NRB_L)

NRB_L_out$extreme_overall <- NRB_L_out$is.extreme

NRB_L_out <- NRB_L_out[c(1,6,19)]



NRB_L_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(NRB_L)

NRB_L_out1$extreme_race_eth <- NRB_L_out1$is.extreme

NRB_L_out1 <- NRB_L_out1[c(2,7,19)]




NRB_L_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(NRB_L)

NRB_L_out2$extreme_gender <- NRB_L_out2$is.extreme

NRB_L_out2 <- NRB_L_out2[c(2,7,19)]



NRB_L_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(NRB_L)

NRB_L_out3$extreme_age <- NRB_L_out3$is.extreme

NRB_L_out3 <- NRB_L_out3[c(2,7,19)]


NRB_L_extreme <- full_join(NRB_L_out, NRB_L_out1, by=c('ID', 'NRB_L'))
NRB_L_extreme <- full_join(NRB_L_extreme, NRB_L_out2, by=c('ID', 'NRB_L'))
NRB_L_extreme <- full_join(NRB_L_extreme, NRB_L_out3, by=c('ID', 'NRB_L'))

NRB_L_extreme <- 
  filter(NRB_L_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

NRB_L_extreme$extreme_overall <- as.character(NRB_L_extreme$extreme_overall)
NRB_L_extreme$extreme_race_eth <- as.character(NRB_L_extreme$extreme_race_eth)
NRB_L_extreme$extreme_gender <- as.character(NRB_L_extreme$extreme_gender)
NRB_L_extreme$extreme_age <- as.character(NRB_L_extreme$extreme_age)


NRB_L_extreme[is.na(NRB_L_extreme)]="Not Outlier"           

#Size 12 Table TNR
flextable(NRB_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("NRB_L Extreme Outliers (mean=17.98mm)") 
#%>% set_header_labels(values = list(NRB_L = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(NRB_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("NRB_L Extreme Outliers (mean=17.98mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(NRB_L = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=NRB_L))+
  geom_bar(stat="bin", bins=25, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="NRB_L Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```



```{r}
#ProS_L
ProS_L_out <- chosen_data2 %>% 
  identify_outliers(ProS_L)

ProS_L_out$extreme_overall <- ProS_L_out$is.extreme

ProS_L_out <- ProS_L_out[c(1,7,19)]



ProS_L_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(ProS_L)

ProS_L_out1$extreme_race_eth <- ProS_L_out1$is.extreme

ProS_L_out1 <- ProS_L_out1[c(2,8,19)]




ProS_L_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(ProS_L)

ProS_L_out2$extreme_gender <- ProS_L_out2$is.extreme

ProS_L_out2 <- ProS_L_out2[c(2,8,19)]



ProS_L_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(ProS_L)

ProS_L_out3$extreme_age <- ProS_L_out3$is.extreme

ProS_L_out3 <- ProS_L_out3[c(2,8,19)]


ProS_L_extreme <- full_join(ProS_L_out, ProS_L_out1, by=c('ID', 'ProS_L'))
ProS_L_extreme <- full_join(ProS_L_extreme, ProS_L_out2, by=c('ID', 'ProS_L'))
ProS_L_extreme <- full_join(ProS_L_extreme, ProS_L_out3, by=c('ID', 'ProS_L'))

ProS_L_extreme <- 
  filter(ProS_L_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

ProS_L_extreme$extreme_overall <- as.character(ProS_L_extreme$extreme_overall)
ProS_L_extreme$extreme_race_eth <- as.character(ProS_L_extreme$extreme_race_eth)
ProS_L_extreme$extreme_gender <- as.character(ProS_L_extreme$extreme_gender)
ProS_L_extreme$extreme_age <- as.character(ProS_L_extreme$extreme_age)

ProS_L_extreme[is.na(ProS_L_extreme)]="Not Outlier"           

#Size 12 Table TNR
flextable(ProS_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("ProS_L Extreme Outliers (mean=19.16mm)") 
#%>% set_header_labels(values = list(ProS_L = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(ProS_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("ProS_L Extreme Outliers (mean=19.16mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(ProS_L = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=ProS_L))+
  geom_bar(stat="bin", bins=25, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="ProS_L Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```


SelP_L
```{r}
#SelP_L
SelP_L_out <- chosen_data2 %>% 
  identify_outliers(SelP_L)

SelP_L_out$extreme_overall <- SelP_L_out$is.extreme

SelP_L_out <- SelP_L_out[c(1,8,19)]



SelP_L_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(SelP_L)

SelP_L_out1$extreme_race_eth <- SelP_L_out1$is.extreme

SelP_L_out1 <- SelP_L_out1[c(2,9,19)]




SelP_L_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(SelP_L)

SelP_L_out2$extreme_gender <- SelP_L_out2$is.extreme

SelP_L_out2 <- SelP_L_out2[c(2,9,19)]



SelP_L_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(SelP_L)

SelP_L_out3$extreme_age <- SelP_L_out3$is.extreme

SelP_L_out3 <- SelP_L_out3[c(2,9,19)]


SelP_L_extreme <- full_join(SelP_L_out, SelP_L_out1, by=c('ID', 'SelP_L'))
SelP_L_extreme <- full_join(SelP_L_extreme, SelP_L_out2, by=c('ID', 'SelP_L'))
SelP_L_extreme <- full_join(SelP_L_extreme, SelP_L_out3, by=c('ID', 'SelP_L'))

SelP_L_extreme <- 
  filter(SelP_L_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

SelP_L_extreme$extreme_overall <- as.character(SelP_L_extreme$extreme_overall)
SelP_L_extreme$extreme_race_eth <- as.character(SelP_L_extreme$extreme_race_eth)
SelP_L_extreme$extreme_gender <- as.character(SelP_L_extreme$extreme_gender)
SelP_L_extreme$extreme_age <- as.character(SelP_L_extreme$extreme_age)

SelP_L_extreme[is.na(SelP_L_extreme)] = "Not Outlier"           

#Size 12 Table TNR
flextable(SelP_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("SelP_L Extreme Outliers (mean=44.53mm)") 
#%>% set_header_labels(values = list(SelP_L = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(SelP_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("SelP_L Extreme Outliers (mean=44.53mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(SelP_L = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=SelP_L))+
  geom_bar(stat="bin", bins=25, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="SelP_L Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```



```{r}
#SelM_L
SelM_L_out <- chosen_data2 %>% 
  identify_outliers(SelM_L)

SelM_L_out$extreme_overall <- SelM_L_out$is.extreme

SelM_L_out <- SelM_L_out[c(1,9,19)]



SelM_L_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(SelM_L)

SelM_L_out1$extreme_race_eth <- SelM_L_out1$is.extreme

SelM_L_out1 <- SelM_L_out1[c(2,10,19)]




SelM_L_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(SelM_L)

SelM_L_out2$extreme_gender <- SelM_L_out2$is.extreme

SelM_L_out2 <- SelM_L_out2[c(2,10,19)]



SelM_L_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(SelM_L)

SelM_L_out3$extreme_age <- SelM_L_out3$is.extreme

SelM_L_out3 <- SelM_L_out3[c(2,10,19)]


SelM_L_extreme <- full_join(SelM_L_out, SelM_L_out1, by=c('ID', 'SelM_L'))
SelM_L_extreme <- full_join(SelM_L_extreme, SelM_L_out2, by=c('ID', 'SelM_L'))
SelM_L_extreme <- full_join(SelM_L_extreme, SelM_L_out3, by=c('ID', 'SelM_L'))

SelM_L_extreme <- 
  filter(SelM_L_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

SelM_L_extreme$extreme_overall <- as.character(SelM_L_extreme$extreme_overall)
SelM_L_extreme$extreme_race_eth <- as.character(SelM_L_extreme$extreme_race_eth)
SelM_L_extreme$extreme_gender <- as.character(SelM_L_extreme$extreme_gender)
SelM_L_extreme$extreme_age <- as.character(SelM_L_extreme$extreme_age)

SelM_L_extreme[is.na(SelM_L_extreme)] = "Not Outlier"           

#Size 12 Table TNR
flextable(SelM_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("SelM_L Extreme Outliers (mean=116.2mm)") 
#%>% set_header_labels(values = list(SelM_L = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(SelM_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("SelM_L Extreme Outliers (mean=116.2mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(SelM_L = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=SelM_L))+
  geom_bar(stat="bin", bins=20, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="SelM_L Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```


```{r}
#SnasM_C
SnasM_C_out <- chosen_data2 %>% 
  identify_outliers(SnasM_C)

SnasM_C_out$extreme_overall <- SnasM_C_out$is.extreme

SnasM_C_out <- SnasM_C_out[c(1,10,19)]



SnasM_C_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(SnasM_C)

SnasM_C_out1$extreme_race_eth <- SnasM_C_out1$is.extreme

SnasM_C_out1 <- SnasM_C_out1[c(2,11,19)]




SnasM_C_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(SnasM_C)

SnasM_C_out2$extreme_gender <- SnasM_C_out2$is.extreme

SnasM_C_out2 <- SnasM_C_out2[c(2,11,19)]



SnasM_C_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(SnasM_C)

SnasM_C_out3$extreme_age <- SnasM_C_out3$is.extreme

SnasM_C_out3 <- SnasM_C_out3[c(2,11,19)]


SnasM_C_extreme <- full_join(SnasM_C_out, SnasM_C_out1, by=c('ID', 'SnasM_C'))
SnasM_C_extreme <- full_join(SnasM_C_extreme, SnasM_C_out2, by=c('ID', 'SnasM_C'))
SnasM_C_extreme <- full_join(SnasM_C_extreme, SnasM_C_out3, by=c('ID', 'SnasM_C'))

SnasM_C_extreme <- 
  filter(SnasM_C_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

SnasM_C_extreme$extreme_overall <- as.character(SnasM_C_extreme$extreme_overall)
SnasM_C_extreme$extreme_race_eth <- as.character(SnasM_C_extreme$extreme_race_eth)
SnasM_C_extreme$extreme_gender <- as.character(SnasM_C_extreme$extreme_gender)
SnasM_C_extreme$extreme_age <- as.character(SnasM_C_extreme$extreme_age)

SnasM_C_extreme[is.na(SnasM_C_extreme)] = "Not Outlier"           

#Size 12 Table TNR
flextable(SnasM_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("SnasM_C Extreme Outliers (mean=75.1mm)") 
#%>% set_header_labels(values = list(SnasM_C = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(SnasM_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("SnasM_C Extreme Outliers (mean=75.1mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(SnasM_C = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=SnasM_C))+
  geom_bar(stat="bin", bins=25, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="SnasM_C Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```



```{r}
#TrSman_C
TrSman_C_out <- chosen_data2 %>% 
  identify_outliers(TrSman_C)

TrSman_C_out$extreme_overall <- TrSman_C_out$is.extreme

TrSman_C_out <- TrSman_C_out[c(1,11,19)]



TrSman_C_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(TrSman_C)

TrSman_C_out1$extreme_race_eth <- TrSman_C_out1$is.extreme

TrSman_C_out1 <- TrSman_C_out1[c(2,12,19)]




TrSman_C_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(TrSman_C)

TrSman_C_out2$extreme_gender <- TrSman_C_out2$is.extreme

TrSman_C_out2 <- TrSman_C_out2[c(2,12,19)]



TrSman_C_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(TrSman_C)

TrSman_C_out3$extreme_age <- TrSman_C_out3$is.extreme

TrSman_C_out3 <- TrSman_C_out3[c(2,12,19)]


TrSman_C_extreme <- full_join(TrSman_C_out, TrSman_C_out1, by=c('ID', 'TrSman_C'))
TrSman_C_extreme <- full_join(TrSman_C_extreme, TrSman_C_out2, by=c('ID', 'TrSman_C'))
TrSman_C_extreme <- full_join(TrSman_C_extreme, TrSman_C_out3, by=c('ID', 'TrSman_C'))

TrSman_C_extreme <- 
  filter(TrSman_C_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

TrSman_C_extreme$extreme_overall <- as.character(TrSman_C_extreme$extreme_overall)
TrSman_C_extreme$extreme_race_eth <- as.character(TrSman_C_extreme$extreme_race_eth)
TrSman_C_extreme$extreme_gender <- as.character(TrSman_C_extreme$extreme_gender)
TrSman_C_extreme$extreme_age <- as.character(TrSman_C_extreme$extreme_age)

TrSman_C_extreme[is.na(TrSman_C_extreme)] = "Not Outlier"           

#Size 12 Table TNR
flextable(TrSman_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("TrSman_C Extreme Outliers (mean=153.4mm)") 
#%>% set_header_labels(values = list(TrSman_C = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(TrSman_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("TrSman_C Extreme Outliers (mean=153.4mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(TrSman_C = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=TrSman_C))+
  geom_bar(stat="bin", bins=30, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="TrSman_C Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```


```{r}
#TrTr_C
TrTr_C_out <- chosen_data2 %>% 
  identify_outliers(TrTr_C)

TrTr_C_out$extreme_overall <- TrTr_C_out$is.extreme

TrTr_C_out <- TrTr_C_out[c(1,12,19)]



TrTr_C_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(TrTr_C)

TrTr_C_out1$extreme_race_eth <- TrTr_C_out1$is.extreme

TrTr_C_out1 <- TrTr_C_out1[c(2,13,19)]




TrTr_C_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(TrTr_C)

TrTr_C_out2$extreme_gender <- TrTr_C_out2$is.extreme

TrTr_C_out2 <- TrTr_C_out2[c(2,13,19)]



TrTr_C_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(TrTr_C)

TrTr_C_out3$extreme_age <- TrTr_C_out3$is.extreme

TrTr_C_out3 <- TrTr_C_out3[c(2,13,19)]


TrTr_C_extreme <- full_join(TrTr_C_out, TrTr_C_out1, by=c('ID', 'TrTr_C'))
TrTr_C_extreme <- full_join(TrTr_C_extreme, TrTr_C_out2, by=c('ID', 'TrTr_C'))
TrTr_C_extreme <- full_join(TrTr_C_extreme, TrTr_C_out3, by=c('ID', 'TrTr_C'))

TrTr_C_extreme <- 
  filter(TrTr_C_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

TrTr_C_extreme$extreme_overall <- as.character(TrTr_C_extreme$extreme_overall)
TrTr_C_extreme$extreme_race_eth <- as.character(TrTr_C_extreme$extreme_race_eth)
TrTr_C_extreme$extreme_gender <- as.character(TrTr_C_extreme$extreme_gender)
TrTr_C_extreme$extreme_age <- as.character(TrTr_C_extreme$extreme_age)

TrTr_C_extreme[is.na(TrTr_C_extreme)] = "Not Outlier"           

#Size 12 Table TNR
flextable(TrTr_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("TrTr_C Extreme Outliers (mean=282.7)") 
#%>% set_header_labels(values = list(TrTr_C = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(TrTr_C_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("TrTr_C Extreme Outliers (mean=282.7)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(TrTr_C = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=TrTr_C))+
  geom_bar(stat="bin", bins=20, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="TrTr_C Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```



```{r}
#TrTr_L
TrTr_L_out <- chosen_data2 %>% 
  identify_outliers(TrTr_L)

TrTr_L_out$extreme_overall <- TrTr_L_out$is.extreme

TrTr_L_out <- TrTr_L_out[c(1,13,19)]



TrTr_L_out1 <- chosen_data2 %>% 
  group_by(race_eth) %>% 
  identify_outliers(TrTr_L)

TrTr_L_out1$extreme_race_eth <- TrTr_L_out1$is.extreme

TrTr_L_out1 <- TrTr_L_out1[c(2,14,19)]




TrTr_L_out2 <- chosen_data2 %>% 
  group_by(gender) %>% 
  identify_outliers(TrTr_L)

TrTr_L_out2$extreme_gender <- TrTr_L_out2$is.extreme

TrTr_L_out2 <- TrTr_L_out2[c(2,14,19)]



TrTr_L_out3 <- chosen_data2 %>% 
  group_by(age_group) %>% 
  identify_outliers(TrTr_L)

TrTr_L_out3$extreme_age <- TrTr_L_out3$is.extreme

TrTr_L_out3 <- TrTr_L_out3[c(2,14,19)]


TrTr_L_extreme <- full_join(TrTr_L_out, TrTr_L_out1, by=c('ID', 'TrTr_L'))
TrTr_L_extreme <- full_join(TrTr_L_extreme, TrTr_L_out2, by=c('ID', 'TrTr_L'))
TrTr_L_extreme <- full_join(TrTr_L_extreme, TrTr_L_out3, by=c('ID', 'TrTr_L'))

TrTr_L_extreme <- 
  filter(TrTr_L_extreme, 
           extreme_overall == "TRUE" | 
           extreme_race_eth == "TRUE" |
           extreme_gender == "TRUE" |
           extreme_age == "TRUE" )

TrTr_L_extreme$extreme_overall <- as.character(TrTr_L_extreme$extreme_overall)
TrTr_L_extreme$extreme_race_eth <- as.character(TrTr_L_extreme$extreme_race_eth)
TrTr_L_extreme$extreme_gender <- as.character(TrTr_L_extreme$extreme_gender)
TrTr_L_extreme$extreme_age <- as.character(TrTr_L_extreme$extreme_age)

TrTr_L_extreme[is.na(TrTr_L_extreme)] = "Not Outlier"           

#Size 12 Table TNR
flextable(TrTr_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("TrTr_L Extreme Outliers (mean=146.5mm)") 
#%>% set_header_labels(values = list(TrTr_L = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(TrTr_L_extreme) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("TrTr_L Extreme Outliers (mean=146.5mm)") %>% 
  fit_to_width(7.5) %>% 
  autofit
#%>% set_header_labels(values = list(TrTr_L = "Alare/AlareCont"))

ggplot(data=chosen_data2, aes(x=TrTr_L))+
  geom_bar(stat="bin", bins=20, color= "black", fill = "white")+
  theme_bw() + theme(text=element_text(family= "Times New Roman"))+
  labs(title="TrTr_L Measurement Distribution",
       subtitle = "NA values removed",
       y="Frequency",
       x="Measurement in mm")
```



```{r}
##outliers
mult_out <- chosen_data2
mult_out <- mult_out %>% drop_na()

#cutoff <- qchisq(1-.001, ncol(mult_out[ , -c(1,14,15,16)]))


mult_out$mahal <- mahalanobis(mult_out[ , -c(1,14,15,16)],
                    colMeans(mult_out[ , -c(1,14,15,16)]),
                    cov(mult_out[ , -c(1,14,15,16)]))

mult_out$p <- pchisq(mult_out$mahal, df=11, lower.tail=FALSE)



mult_out$multv_outlier <- with(mult_out, ifelse(p < 0.001, 'TRUE', 'FALSE'))

mult_out <- mult_out %>% 
  filter(multv_outlier == TRUE)


##df
#summary(mahal < cutoff)

#mult_out2 <- chosen_data2 %>%
 #mahalanobis_distance() %>%
 #filter(is.outlier == TRUE) %>%
  #as.data.frame()

#mult_out2

##exclude outliers
#noout = subset(nomiss, mahal < cutoff)
```


```{r}
AA_C_extreme$offending <- "AA_C univar"
BiW_C_extreme$offending <- "BiW_C univar"
BiW_L_extreme$offending <- "BiW_L univar"
GoSub_C_extreme$offending <- "GoSub_C univar"
NRB_L_extreme$offending <- "NRB_L univar"
ProS_L_extreme$offending <- "ProS_L univar"
SelP_L_extreme$offending <- "SelP_L univar"
SelM_L_extreme$offending <- "SelM_L univar"
SnasM_C_extreme$offending <- "SnasM_C univar"
TrSman_C_extreme$offending <- "TrSman_C univar"
TrTr_C_extreme$offending <- "TrTr_C univar"
TrTr_L_extreme$offending <- "TrTr_L univar"
```


```{r}
all_extreme <- full_join(AA_C_extreme, BiW_C_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, BiW_L_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, GoSub_C_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, NRB_L_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, ProS_L_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, SelP_L_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, SelM_L_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, SnasM_C_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, TrSman_C_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, TrTr_C_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))

all_extreme <- full_join(all_extreme, TrTr_L_extreme, by=c('ID', 
                                                        'extreme_overall', 
                                                        'extreme_race_eth', 
                                                        'extreme_gender',
                                                        'extreme_age',
                                                        'offending'))
```




```{r}
combin_out <- full_join(mult_out, all_extreme, by=c('ID'))

str(combin_out)
```

```{r}

combin_out1 <- combin_out[c(1,19,25,21,22,23,24)]

combin_out1$offending[is.na(combin_out1$offending)] = "Not Univar Outlier" 

combin_out1[is.na(combin_out1)] = "Not Outlier"  

str(combin_out1)
```

```{r}

combin_out1$multv_outlier <- factor(combin_out1$multv_outlier, levels = c("TRUE", "FALSE", "Not Outlier"))
combin_out1$extreme_overall <- factor(combin_out1$extreme_overall, levels = c("TRUE", "FALSE", "Not Outlier"))
combin_out1$extreme_race_eth <- factor(combin_out1$extreme_race_eth, levels = c("TRUE", "FALSE", "Not Outlier"))
combin_out1$extreme_gender <- factor(combin_out1$extreme_gender, levels = c("TRUE", "FALSE", "Not Outlier"))
combin_out1$extreme_age <- factor(combin_out1$extreme_age, levels = c("TRUE", "FALSE", "Not Outlier"))


arrange(combin_out1, multv_outlier + extreme_overall)
#combin_out1[with(combin_out1, order("multv_outlier", "extreme_overall", "extreme_race_eth", "extreme_gender", "extreme_age")), ]
```



```{r}
#Size 12 Table TNR
flextable(combin_out1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Univariate and Multivariate Outlier Status") %>% 
  autofit
#%>% set_header_labels(values = list(TrTr_L = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(combin_out1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Univariate and Multivariate Outlier Status") %>% 
  autofit() %>% 
  fit_to_width(7.5)
  
#%>% set_header_labels(values = list(TrTr_L = "Alare/AlareCont"))
```






```{r}
vis_outliers <- read_excel("C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\all_vis_out1.xlsx")
```



```{r}
filtered_visoutl <- filter(vis_outliers, vis_out %in% c("GoSub_C", 
                                                      "NRB_L", 
                                                      "SnasM_C", 
                                                      "TrSman_C"))
```

```{r}
stat_outliers <- combin_out1

all_outliers <- full_join(filtered_visoutl, stat_outliers, by="ID")
```

all the visual outliers that were changed to NA based on visual assessment of
measurement sumstats are also stat outliers (univariate AND multivariate)

```{r}
all_outliers1 <- all_outliers

all_outliers1$truee <- "1"

all_outliers1 <- all_outliers1[c(1:4,9)]

all_outliers1 <- all_outliers1 %>% pivot_wider(names_from = offending, values_from = truee)

str(all_outliers1)
```

```{r}


all_outliers1[is.na(all_outliers1)]="0"

all_outliers1$`GoSub_C univar` <- as.numeric(all_outliers1$`GoSub_C univar`)
all_outliers1$`TrSman_C univar` <- as.numeric(all_outliers1$`TrSman_C univar`)
all_outliers1$`NRB_L univar` <- as.numeric(all_outliers1$`NRB_L univar`)
all_outliers1$`SnasM_C univar`<- as.numeric(all_outliers1$`SnasM_C univar`)
all_outliers1$`ProS_L univar` <- as.numeric(all_outliers1$`ProS_L univar`)
all_outliers1$`SelP_L univar` <- as.numeric(all_outliers1$`SelP_L univar`)
all_outliers1$`SelM_L univar` <- as.numeric(all_outliers1$`SelM_L univar`)
all_outliers1$`AA_C univar` <- as.numeric(all_outliers1$`AA_C univar`)
all_outliers1$`BiW_C univar` <- as.numeric(all_outliers1$`BiW_C univar`)


all_outliers1$univar_sum <- all_outliers1$`GoSub_C univar` + 
                            all_outliers1$`TrSman_C univar` + 
                            all_outliers1$`NRB_L univar` +
                            all_outliers1$`SnasM_C univar` + 
                            all_outliers1$`ProS_L univar` + 
                            all_outliers1$`SelP_L univar` +
                            all_outliers1$`SelM_L univar` + 
                            all_outliers1$`AA_C univar` + 
                            all_outliers1$`BiW_C univar`

```

```{r}


all_outliers1$`GoSub_C univar` <- as.character(all_outliers1$`GoSub_C univar`)
all_outliers1$`TrSman_C univar` <- as.character(all_outliers1$`TrSman_C univar`)
all_outliers1$`NRB_L univar` <- as.character(all_outliers1$`NRB_L univar`)
all_outliers1$`SnasM_C univar`<- as.character(all_outliers1$`SnasM_C univar`)
all_outliers1$`ProS_L univar` <- as.character(all_outliers1$`ProS_L univar`)
all_outliers1$`SelP_L univar` <- as.character(all_outliers1$`SelP_L univar`)
all_outliers1$`SelM_L univar` <- as.character(all_outliers1$`SelM_L univar`)
all_outliers1$`AA_C univar` <- as.character(all_outliers1$`AA_C univar`)
all_outliers1$`BiW_C univar` <- as.character(all_outliers1$`BiW_C univar`)



all_outliers1$`GoSub_C univar`<-  
  recode_factor(all_outliers1$`GoSub_C univar`, '0'= "no",'1' = "GoSub_C")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`GoSub_C univar` = na_if_in(`GoSub_C univar`, "no"))


all_outliers1$`TrSman_C univar`<-  
  recode_factor(all_outliers1$`TrSman_C univar`, '0'= "no",'1' = "TrSman_C")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`TrSman_C univar` = na_if_in(`TrSman_C univar`, "no"))


all_outliers1$`NRB_L univar` <-  
  recode_factor(all_outliers1$`NRB_L univar`, '0'= "no",'1' = "NRB_L")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`NRB_L univar`= na_if_in(`NRB_L univar`, "no"))


all_outliers1$`SnasM_C univar` <-  
  recode_factor(all_outliers1$`SnasM_C univar`, '0'= "no",'1' = "SnasM_C")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`SnasM_C univar`= na_if_in(`SnasM_C univar`, "no"))


all_outliers1$`ProS_L univar` <-  
  recode_factor(all_outliers1$`ProS_L univar`, '0'= "no",'1' = "ProS_L")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`ProS_L univar`= na_if_in(`ProS_L univar`, "no"))


all_outliers1$`SelP_L univar` <-  
  recode_factor(all_outliers1$`SelP_L univar`, '0'= "no",'1' = "SelP_L")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`SelP_L univar`= na_if_in(`SelP_L univar`, "no"))


all_outliers1$`SelM_L univar` <-  
  recode_factor(all_outliers1$`SelM_L univar`, '0'= "no",'1' = "SelM_L")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`SelM_L univar`= na_if_in(`SelM_L univar`, "no"))


all_outliers1$`AA_C univar` <-  
  recode_factor(all_outliers1$`AA_C univar`, '0'= "no",'1' = "AA_C")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`AA_C univar`= na_if_in(`AA_C univar`, "no"))


all_outliers1$`BiW_C univar` <-  
  recode_factor(all_outliers1$`BiW_C univar`, '0'= "no",'1' = "BiW_C")
#all_outliers1 <- all_outliers1 %>% 
  #mutate(`BiW_C univar`= na_if_in(`BiW_C univar`, "no"))
```

```{r}
cols <- c("GoSub_C univar",
          "TrSman_C univar",
          "NRB_L univar",
          "SnasM_C univar",
          "ProS_L univar",
          "SelP_L univar",
          "SelM_L univar",
          "AA_C univar",
          "BiW_C univar")



all_outliers1$univar_outliers <- apply( all_outliers1[ , cols], 1, paste, collapse="&")

all_outliers1$univar_outliers <- gsub("no","",as.character(all_outliers1$univar_outliers))

all_outliers1$univar_outliers <- gsub("&&","",as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&&&","",as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&&&&","",as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&&&&&","",as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&&&&&&","",as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&&&&&&&","",as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&&&&&&&&","",as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&&&&&&&&&","",as.character(all_outliers1$univar_outliers))


	
  
all_outliers1$univar_outliers <- gsub("GoSub_C&TrSman_C&", "GoSub_C & TrSman_C", as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&SnasM_C&", "SnasM_C", as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&SelP_L&SelM_L", "SelP_L & SelM_L", as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&TrSman_C&", "TrSman_C", as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&SelP_L&", "SelP_L", as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("&AA_C&", "AA_C", as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("SnasM_CProS_L", "SnasM_C & ProS_L", as.character(all_outliers1$univar_outliers))
all_outliers1$univar_outliers <- gsub("ProS_LAA_CBiW_C", "AA_C, BiW_C, & ProS_L", as.character(all_outliers1$univar_outliers))


all_outliers1 <- all_outliers1 %>% 
  mutate(univar_outliers= na_if_in(univar_outliers, ""))

```

```{r}
all_outliers1$vis_out <- gsub("0", "Not Visual Outlier", as.character(all_outliers1$vis_out))
all_outliers1$multv_outlier <- gsub("TRUE", "Multivariate Outlier", as.character(all_outliers1$multv_outlier))
all_outliers1$multv_outlier <- gsub("Not Outlier", "Not Multivariate Outlier", as.character(all_outliers1$multv_outlier))

all_outliers1$univar_outliers <- all_outliers1$univar_outliers %>% 
  replace_na("Not Univariate Outlier")
```

```{r}
all_outliers1 <- all_outliers1[c(1,2,16,3)]

```



```{r}
#Size 12 Table TNR
flextable(all_outliers1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Univariate, Multivariate, and Visual Outlier Status") %>% 
  autofit
#%>% set_header_labels(values = list(TrTr_L = "Alare/AlareCont"))

#Autofit Width Table TNR
flextable(all_outliers1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Univariate, Multivariate, and Visual Outlier Status") %>% 
  autofit() %>% 
  fit_to_width(7.5)
```

```{r}
str_count(all_outliers1, "Not Visual Outlier")
str_count(all_outliers1, "Not Univariate Outlier")
str_count(all_outliers1, "Not Multivariate Outlier")
```
4 visual outliers
25 univariate outliers
18 multivariate outliers
(overlap between above numbers, total 31 outliers to change to NA)


NEXT STEPS:

Chosen_data2 is full dataset with following transformations:
12 chosen measurement vars
cm to mm
small demographic categories to other

```{r}
out_na <- full_join(all_outliers1, chosen_data2, by="ID")

demographics <- chosen_data2[c(1, 14:16)]

out_na <- out_na[-c(17:19)]
#add demograpic variables back in later
```

```{r}
#change multivariate outliers to NA

sum(is.na(out_na[c(5:16)]))

which(out_na == "Multivariate Outlier", arr.ind=TRUE)

out_na1 <- out_na

18*12

891+216

out_na1 <- column_to_rownames(out_na1, "ID")
  
out_na1[1:18,] <- NA

out_na1 <- rownames_to_column(out_na1, "ID")

sum(is.na(out_na1[c(5:16)]))
```

```{r}
#which(out_na1 == "AA_C", arr.ind=TRUE)
#out_na1[20, ]
#out_na1$AA_C[out_na1$univar_outliers == "AA_C" & out_na1$AA_C == 45] <- NA
out_na1$AA_C[out_na1$univar_outliers == "AA_C"] <- NA
out_na1$AA_C[out_na1$univar_outliers == "AA_C, BiW_C, & ProS_L"] <- NA
```

```{r}
#which(out_na1 == "BiW_C", arr.ind=TRUE)
#out_na1[21, ]
#out_na1$BiW_C[out_na1$univar_outliers == "BiW_C" & out_na1$BiW_C == 188] <- NA
out_na1$BiW_C[out_na1$univar_outliers == "BiW_C"] <- NA
out_na1$BiW_C[out_na1$univar_outliers == "AA_C, BiW_C, & ProS_L"] <- NA
```

```{r}
#which(out_na1 == "NRB_L", arr.ind=TRUE)
#out_na1[22, ]
#out_na1$NRB_L[out_na1$univar_outliers == "NRB_L" & out_na1$NRB_L == 40] <- NA
out_na1$NRB_L[out_na1$univar_outliers == "NRB_L"] <- NA
```

```{r}
#which(out_na1 == "ProS_L", arr.ind=TRUE)
#out_na1[23, ]
#out_na1$ProS_L[out_na1$univar_outliers == "ProS_L" & out_na1$ProS_L == 30] <- NA
out_na1$ProS_L[out_na1$univar_outliers == "ProS_L"] <- NA
out_na1$ProS_L[out_na1$univar_outliers == "AA_C, BiW_C, & ProS_L"] <- NA
```

```{r}
#which(out_na1 == "SelP_L", arr.ind=TRUE)
#out_na1[24, ]
#out_na1[25, ]

#out_na1$SelP_L[out_na1$univar_outliers == "SelP_L" & out_na1$SelP_L == 51] <- NA
#out_na1$SelP_L[out_na1$univar_outliers == "SelP_L" & out_na1$SelP_L == 52] <- NA

out_na1$SelP_L[out_na1$univar_outliers == "SelP_L"] <- NA

```


```{r}
#which(out_na1 == "SelM_L", arr.ind=TRUE)

out_na1$SelM_L[out_na1$univar_outliers == "SelM_L"] <- NA
```

```{r}
#which(out_na1 == "TrSman_C", arr.ind=TRUE)

out_na1$TrSman_C[out_na1$univar_outliers == "TrSman_C"] <- NA
```


Writing dataset with NA values retained, so they can be analyzed if needed (maybe by demographic)

```{r}
chosen_withna <- full_join(out_na1, demographics, by="ID")
chosen_withna <- chosen_withna[-c(2:4)]
str(chosen_withna)
```



CREATING CHOSEN_NONA
removing NA values by entire row
```{r}
chosen_nona <- chosen_withna %>% drop_na()
str(chosen_nona)
```


IMPUTING
```{r}
imputing <- chosen_withna 

imputing <- imputing %>% arrange(ID)

imputing <- column_to_rownames(imputing, "ID")

imputing_num <- select_if(imputing, is.numeric)

#imputing <- rownames_to_column(imputing, "ID")



#https://rmisstastic.netlify.app/how-to/impute/missimp
#https://www.youtube.com/watch?v=YDbx2pk9xNY

ncp.pca <- estim_ncpPCA(imputing_num,ncp.min=0, ncp.max=5)$ncp



imputed <- imputePCA(imputing_num, ncp=ncp.pca)
chosen_imputed <- as.data.frame(imputed$completeObs)
chosen_imputed <- round(chosen_imputed, 0)

chosen_imputed <- rownames_to_column(chosen_imputed, "ID")



chosen_imputed <- full_join(chosen_imputed, demographics, by="ID")
```


```{r}
write_xlsx(chosen_withna, "C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\chosen_withna.xlsx")
write_xlsx(chosen_nona, "C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\chosen_nona.xlsx")
write_xlsx(chosen_imputed, "C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\chosen_imputed.xlsx")
```


