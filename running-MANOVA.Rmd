---
title: "running-MANOVA"
output: html_document
date: "2022-09-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(tidyverse)
library(readxl)
library(officer)
library(flextable)
library(extrafont)
library(writexl)
library(rstatix)
library(corrr)
library(corrplot)
library(car)
library(heplots)
library(broom)
library(emmeans)
```

```{r}
#times new roman tables
my_ft_theme <- function(ft, ...) {
  # Remove vertical cell padding
  ft <- padding(ft, padding.top = 0, padding.bottom = 0, part = "all")
  
  # Change font to TNR 11
  ft <- font(ft, fontname = "Times New Roman", part = "all")
  ft <- fontsize(ft, part = "all", size = 12)
  ft
}
```

```{r}

chosen_nona1 <- read_excel("C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\chosen_nona1.xlsx")

variables <- cbind(chosen_nona1$AA_C, chosen_nona1$BiW_C, chosen_nona1$BiW_L, 
                   chosen_nona1$GoSub_C, chosen_nona1$NRB_L, chosen_nona1$ProS_L,
                   chosen_nona1$SelP_L, chosen_nona1$SelM_L, chosen_nona1$SnasM_C,
                   chosen_nona1$TrSman_C, chosen_nona1$TrTr_C, chosen_nona1$TrTr_L)
```

#https://www.hindawi.com/journals/cmmm/2019/2173638/ 
Use Pillai! better for when we don't know enough about covariance

#https://www.sagepub.com/sites/default/files/upm-assets/9761_book_item_9761.pdf
Type III sum of squares can be used in models where there are uneven group sizes, although there needs to be at least one participant in each cell. It calculates the sum of squares after the independent variables have all been adjusted for the inclusion of all other independent variables in the model


```{r}
output<-lm(variables ~ gender+race_eth+age_group, data=chosen_nona1,
           contrasts = list(gender=contr.sum, race_eth=contr.sum, age_group=contr.sum))

manova_out_nona1 <- Manova(output, type="III")

summary(manova_out_nona1)
```


```{r}
output1<-manova(variables ~ gender+race_eth+age_group, data=chosen_nona1)

#type 3 and type 1 give same Pillai values

summary(output1)
```


```{r}
output2<-as.data.frame(tidy(output1))

output2$p.value <- formatC(output2$p.value, format = "e")

output2 <- rename(output2, f.statistic = statistic)

#Autofit Width Table TNR
flextable(output2) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Additive MANOVA Model Findings") %>% 
  fit_to_width(7.5) %>% 
  autofit()
```

From 511 notes: 

The experimentwise error rate (EER) is the probability of having at
least one false rejection in the group of tests from a single experiment
or study. The “experiment” is the ANOVA analysis.


John Tukey proposed a method that can be used to run all pairwise
comparisons while controlling EER.

Tukey ME > Unadj ME, hence we will find evidence of fewer
differences (or weaker evidence of differences) using Tukey’s
method.



```{r}
AA_Cout <- aov(AA_C ~ gender+race_eth+age_group, data=chosen_nona1)
summary(AA_Cout)
AA_Cout_data <- as.data.frame(tidy(AA_Cout))
```

```{r}
AA_Cout_data <- rename(AA_Cout_data, f.statistic = statistic)
AA_Cout_data$signif <- with(AA_Cout_data, ifelse(p.value < 0.05, 'TRUE', 'FALSE'))
AA_Cout_data$p.value <- formatC(AA_Cout_data$p.value, format = "e")


#Autofit Width Table TNR
flextable(AA_Cout_data) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("AA_C Additive Anova Model Findings") %>% 
  fit_to_width(7.5) %>% 
  autofit()
```


```{r}
AA_Cg_em <- emmeans(AA_Cout, ~ gender)
AA_Cg_em1 <- as.data.frame(AA_Cg_em)

AA_Cg_em 

flextable(AA_Cg_em1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Estimated Marginal Means: AA_C and Gender") %>% 
  fit_to_width(7.5) %>% 
  autofit()


AA_Cg_em2 <- pairs(AA_Cg_em, adjust="Tukey")
AA_Cg_em3 <- as.data.frame(AA_Cg_em2)

AA_Cg_em3$signif <- with(AA_Cg_em3, ifelse(p.value < 0.05, 'TRUE', 'FALSE'))
AA_Cg_em3$p.value <- formatC(AA_Cg_em3$p.value, format = "e")

AA_Cg_em2

flextable(AA_Cg_em3) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Tukey Pairwise Comparisons: AA_C and Gender") %>% 
  fit_to_width(7.5) %>% 
  autofit()


emmip_AA_Cg <- emmip(AA_Cout, ~ gender, CIs = TRUE)

emmip_AA_Cg + 
  theme_bw()+theme(text=element_text(family= "Times New Roman"))+
  labs(title="AA_C and Gender: Estimated Marginal Means Plot",
       subtitle="With Confidence Intervals",
       y="Linear Prediction (of measurement in mm)",
       x="Levels of Gender")
  
```


```{r}
AA_Cr_em <- emmeans(AA_Cout, ~ race_eth)
AA_Cr_em1 <- as.data.frame(AA_Cr_em)

AA_Cr_em 

flextable(AA_Cr_em1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Estimated Marrinal Means: AA_C and Race/Ethnicity") %>% 
  fit_to_width(7.5) %>% 
  autofit()


AA_Cr_em2 <- pairs(AA_Cr_em, adjust="Tukey")
AA_Cr_em3 <- as.data.frame(AA_Cr_em2)

AA_Cr_em3$signif <- with(AA_Cr_em3, ifelse(p.value < 0.05, 'TRUE', 'FALSE'))
AA_Cr_em3$p.value <- formatC(AA_Cr_em3$p.value, format = "e")



AA_Cr_em2

flextable(AA_Cr_em3) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Tukey Pairwise Comparisons: AA_C and Race/Ethnicity") %>% 
  fit_to_width(7.5) %>% 
  autofit()


emmip_AA_Cr <- emmip(AA_Cout, ~ race_eth, CIs = TRUE)

emmip_AA_Cr + 
  theme_bw()+theme(text=element_text(family= "Times New Roman"))+
  labs(title="AA_C and Race/Ethnicity: Estimated Marginal Means Plot",
       subtitle="With Confidence Intervals",
       y="Linear Prediction (of measurement in mm)",
       x="Levels of Race/Ethnicity")
```
```{r}
AA_Ca_em <- emmeans(AA_Cout, ~ age_group)
AA_Ca_em1 <- as.data.frame(AA_Ca_em)

AA_Ca_em 

flextable(AA_Ca_em1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Estimated Marainal Means: AA_C and Age Group") %>% 
  fit_to_width(7.5) %>% 
  autofit()


AA_Ca_em2 <- pairs(AA_Ca_em, adjust="Tukey")
AA_Ca_em3 <- as.data.frame(AA_Ca_em2)

AA_Ca_em3$signif <- with(AA_Ca_em3, ifelse(p.value < 0.05, 'TRUE', 'FALSE'))
AA_Ca_em3$p.value <- formatC(AA_Ca_em3$p.value, format = "e")

AA_Ca_em2

flextable(AA_Ca_em3) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Tukey Pairwise Comparisons: AA_C and Age Group") %>% 
  fit_to_width(7.5) %>% 
  autofit()


emmip_AA_Ca <- emmip(AA_Cout, ~ age_group, CIs = TRUE)

emmip_AA_Ca + 
  theme_bw()+theme(text=element_text(family= "Times New Roman"))+
  labs(title="AA_C and Age Group: Estimated Marainal Means Plot",
       subtitle="With Confidence Intervals",
       y="Linear Prediction (of measurement in mm)",
       x="Levels of Age Group")
```










```{r}
BiW_Lout <- aov(BiW_L ~ gender+race_eth+age_group, data=chosen_nona1)
summary(BiW_Lout)
BiW_Lout_data <- as.data.frame(tidy(BiW_Lout))
```

```{r}
BiW_Lout_data <- rename(BiW_Lout_data, f.statistic = statistic)
BiW_Lout_data$signif <- with(BiW_Lout_data, ifelse(p.value < 0.05, 'TRUE', 'FALSE'))
BiW_Lout_data$p.value <- formatC(BiW_Lout_data$p.value, format = "e")

#Autofit Width Table TNR
flextable(BiW_Lout_data) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("BiW_L Additive Anova Model Findings") %>% 
  fit_to_width(7.5) %>% 
  autofit()
```


```{r}
BiW_Lg_em <- emmeans(BiW_Lout, ~ gender)
BiW_Lg_em1 <- as.data.frame(BiW_Lg_em)

BiW_Lg_em 

flextable(BiW_Lg_em1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Estimated Marginal Means: BiW_L and Gender") %>% 
  fit_to_width(7.5) %>% 
  autofit()


BiW_Lg_em2 <- pairs(BiW_Lg_em, adjust="Tukey")
BiW_Lg_em3 <- as.data.frame(BiW_Lg_em2)

BiW_Lg_em3$signif <- with(BiW_Lg_em3, ifelse(p.value < 0.05, 'TRUE', 'FALSE'))
BiW_Lg_em3$p.value <- formatC(BiW_Lg_em3$p.value, format = "e")

BiW_Lg_em2

flextable(BiW_Lg_em3) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Tukey Pairwise Comparisons: BiW_L and Gender") %>% 
  fit_to_width(7.5) %>% 
  autofit()


emmip_BiW_Lg <- emmip(BiW_Lout, ~ gender, CIs = TRUE)

emmip_BiW_Lg + 
  theme_bw()+theme(text=element_text(family= "Times New Roman"))+
  labs(title="BiW_L and Gender: Estimated Marginal Means Plot",
       subtitle="With Confidence Intervals",
       y="Linear Prediction (of measurement in mm)",
       x="Levels of Gender")
  
```


```{r}
BiW_Lr_em <- emmeans(BiW_Lout, ~ race_eth)
BiW_Lr_em1 <- as.data.frame(BiW_Lr_em)

BiW_Lr_em 

flextable(BiW_Lr_em1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Estimated Marrinal Means: BiW_L and Race/Ethnicity") %>% 
  fit_to_width(7.5) %>% 
  autofit()


BiW_Lr_em2 <- pairs(BiW_Lr_em, adjust="Tukey")
BiW_Lr_em3 <- as.data.frame(BiW_Lr_em2)

BiW_Lr_em3$signif <- with(BiW_Lr_em3, ifelse(p.value < 0.05, 'TRUE', 'FALSE'))
BiW_Lr_em3$p.value <- formatC(BiW_Lr_em3$p.value, format = "e")

BiW_Lr_em2

flextable(BiW_Lr_em3) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Tukey Pairwise Comparisons: BiW_L and Race/Ethnicity") %>% 
  fit_to_width(7.5) %>% 
  autofit()


emmip_BiW_Lr <- emmip(BiW_Lout, ~ race_eth, CIs = TRUE)

emmip_BiW_Lr + 
  theme_bw()+theme(text=element_text(family= "Times New Roman"))+
  labs(title="BiW_L and Race/Ethnicity: Estimated Marrinal Means Plot",
       subtitle="With Confidence Intervals",
       y="Linear Prediction (of measurement in mm)",
       x="Levels of Race/Ethnicity")
```
```{r}
BiW_La_em <- emmeans(BiW_Lout, ~ age_group)
BiW_La_em1 <- as.data.frame(BiW_La_em)

BiW_La_em 

flextable(BiW_La_em1) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Estimated Marainal Means: BiW_L and Age Group") %>% 
  fit_to_width(7.5) %>% 
  autofit()


BiW_La_em2 <- pairs(BiW_La_em, adjust="Tukey")
BiW_La_em3 <- as.data.frame(BiW_La_em2)

BiW_La_em3$signif <- with(BiW_La_em3, ifelse(p.value < 0.05, 'TRUE', 'FALSE'))
BiW_La_em3$p.value <- formatC(BiW_La_em3$p.value, format = "e")

BiW_La_em2

flextable(BiW_La_em3) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("Tukey Pairwise Comparisons: BiW_L and Age Group") %>% 
  fit_to_width(7.5) %>% 
  autofit()


emmip_BiW_La <- emmip(BiW_Lout, ~ age_group, CIs = TRUE)

emmip_BiW_La + 
  theme_bw()+theme(text=element_text(family= "Times New Roman"))+
  labs(title="BiW_L and Age Group: Estimated Marainal Means Plot",
       subtitle="With Confidence Intervals",
       y="Linear Prediction (of measurement in mm)",
       x="Levels of Age Group")
```


