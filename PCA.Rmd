---
title: "PCA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(flextable)
library(readxl)
library(extrafont)
library(forcats)
library(writexl)
library(ggfortify)
```

```{r table-function}
#times new roman tables
my_ft_theme <- function(ft, ...) {
  # Remove vertical cell padding
  ft <- padding(ft, padding.top = 0, padding.bottom = 0, part = "all")
  
  # Change font to TNR 11
  ft <- font(ft, fontname = "Times New Roman", part = "all")
  ft <- fontsize(ft, part = "all", size = 12)
  ft
}
```

```{r}
#remove identifiers and demographic data

headscan_full1<-read_excel("C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\headscan_full.xlsx")

headscan_full1$AA_C <- headscan_full1$AA_C *10
headscan_full1$BGl_C <- headscan_full1$BGl_C * 10
headscan_full1$BiW_C <- headscan_full1$BiW_C *10
headscan_full1$BiW_L <- headscan_full1$BiW_L *10
headscan_full1$ChCh_C <- headscan_full1$ChCh_C *10
headscan_full1$GoSub_C <- headscan_full1$GoSub_C *10
headscan_full1$NRB_L <- headscan_full1$NRB_L *10
headscan_full1$ProA_L <- headscan_full1$ProA_L *10
headscan_full1$ProA_C <- headscan_full1$ProA_C *10
headscan_full1$ProS_C <- headscan_full1$ProS_C *10
headscan_full1$ProS_L <- headscan_full1$ProS_L *10
headscan_full1$SelP_C <- headscan_full1$SelP_C *10
headscan_full1$SelP_L <- headscan_full1$SelP_L *10
headscan_full1$SelDH_C <- headscan_full1$SelDH_C *10
headscan_full1$SelM_L <- headscan_full1$SelM_L *10
headscan_full1$SnasM_C <- headscan_full1$SnasM_C *10
headscan_full1$SmanM_C <- headscan_full1$SmanM_C *10
headscan_full1$SmanM_L <- headscan_full1$SmanM_L *10
headscan_full1$SnasM_L <- headscan_full1$SnasM_L *10
headscan_full1$TrHO_C <- headscan_full1$TrHO_C *10
headscan_full1$TrEJ_C <- headscan_full1$TrEJ_C *10
headscan_full1$TrGo_C <- headscan_full1$TrGo_C *10
headscan_full1$TrSel_C <- headscan_full1$TrSel_C *10
headscan_full1$TrSman_C <- headscan_full1$TrSman_C *10
headscan_full1$TrSnas_C <- headscan_full1$TrSnas_C *10
headscan_full1$TrTr_C <- headscan_full1$TrTr_C *10
headscan_full1$TrTr_L <- headscan_full1$TrTr_L *10

str(headscan_full1)
```

```{r}
n_occur <- data.frame(table(headscan_full1$ID))
n_occur[n_occur$Freq > 1,]
headscan_full1[headscan_full1$ID %in% n_occur$Var1[n_occur$Freq > 1],]
```


```{r}
PCAdata_num <- headscan_full1[c(1,2,4,5,7,8,12,14,16,17,25,27,28)]

PCAdata_full <- headscan_full1[c(1,2,4,5,7,8,12,14,16,17,25,27,28,31,32,33)]
```


```{r}
measureNAs <- read_excel("C:\\Users\\19177\\OneDrive - Colostate\\Desktop\\Dissertation\\headscan_dissertation\\measureNAs.xlsx")

PCA_NAs <- slice(measureNAs, c(1,3,4,6,7,11,13,15,16,24,26,27))

#Size 12 Table TNR
flextable(PCA_NAs) %>%
  my_ft_theme()%>% 
  bold(part = "header") %>% 
  set_caption("NA values for PCA Measurement Locations, total 891 NA values") %>% 
  autofit() %>% 
  set_header_labels(values = list(measure_name = "Measurement Location",
                                  measureNAprops = "Proportion of NA values",
                                  measureNAsums = "Count of NA values"))
```



```{r}
PCAdata_num <- PCAdata_num %>% drop_na()

str(PCAdata_num)
```

```{r}
PCAdata_full <- left_join(PCAdata_num, PCAdata_full, by= "ID")

n_occur <- data.frame(table(PCAdata_full$ID))
n_occur[n_occur$Freq > 1,]
PCAdata_full[PCAdata_full$ID %in% n_occur$Var1[n_occur$Freq > 1],]


```


```{r}
PCAdata_num <- PCAdata_num[-c(1)]
PCAdata_full <- PCAdata_full[-c(1)]
```


```{r}
#calculate principal components
results <- prcomp(PCAdata_num, scale=TRUE)

#reverse the signs (R calculates eigenvectors in negative direction)
results$rotation <- -1*results$rotation

#display PCs
results$rotation
```

```{r}
var_explained = results$sdev^2 / sum(results$sdev^2)
```


```{r, fig.width=5, fig.height=4}
qplot(c(1:12), var_explained) + 
  geom_line() + 
  xlab("Principal Component") + 
  ylab("Variance Explained (proportion)") +
  ggtitle("Scree Plot") +
  ylim(0, 1) +
  scale_x_discrete(limits=c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12"))
```


```{r}
pca_res <- prcomp(PCAdata_num, scale.=TRUE)



autoplot(pca_res, data=PCAdata_full, color="race_eth")
```









